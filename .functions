#! /bin/bash

function postgres_container {
  if [ -z "$1" ] || [ -z "$2" ]
  then
    echo 'Starting postgres container with default user and password'
    docker run -d -p 5432:5432 postgres
    echo "USER: postgres"
    echo "PASSWORD: postgres"
  else
    echo 'Starting postgres container with indicated user and password'
    docker run -d -p 5432:5432 -e POSTGRES_USER=$1 -e POSTGRES_PASSWORD=$2 postgres
    echo "USER: $1"
    echo "PASSWORD: $2"
  fi
}

function bash_container {
  if [ -z "$1" ]
  then
    echo "You forgot to inform a container name or id"
  else
    echo "Starting bash on $1"
    docker exec -i -t $1 /bin/bash
  fi
}

function postgres_container_extension {
  if [ "$1" ]
  then
    docker exec -it $1 psql -U postgres -d template1 -c 'create extension "uuid-ossp";'
  else
    echo "You forgot to inform a container name or id"
  fi
}

function postgres_username { ruby -e 'require "yaml"; p YAML.load(File.read("config/database.yml"))["defaults"]["username"]' }
function postgres_password { ruby -e 'require "yaml"; p YAML.load(File.read("config/database.yml"))["defaults"]["password"]' }

function ask { claude -p "$*"}

function op_env_cache_is_fresh() {
  local cache_file="$1"
  local cache_ttl="$2"
  [[ -r "$cache_file" ]] || return 1

  local now mtime
  now="$(date +%s)"
  mtime="$(stat -f %m "$cache_file" 2>/dev/null || stat -c %Y "$cache_file" 2>/dev/null)" || return 1
  (( now - mtime < cache_ttl ))
}

function op_env_load_from_cache() {
  local cache_file="$1"
  shift

  [[ -r "$cache_file" ]] || return 1
  # shellcheck disable=SC1090
  source "$cache_file"

  local var_name
  for var_name in "$@"; do
    [[ -n "${(P)var_name}" ]] || return 1
  done
}

# Usage:
# op_env_setup <cache_file> <cache_ttl_seconds> VAR_NAME=op://vault/item/field [MORE...]
function op_env_setup() {
  local cache_file="$1"
  local cache_ttl="$2"
  shift 2

  (( $# > 0 )) || return 1

  local mapping var_name op_ref
  local -a var_names=()
  for mapping in "$@"; do
    var_name="${mapping%%=*}"
    op_ref="${mapping#*=}"
    [[ -n "$var_name" && -n "$op_ref" && "$mapping" == *"="* ]] || continue
    var_names+=("$var_name")
  done

  if op_env_cache_is_fresh "$cache_file" "$cache_ttl" && op_env_load_from_cache "$cache_file" "${var_names[@]}"; then
    return 0
  fi

  command -v op >/dev/null 2>&1 || return 1

  local fetched_value
  local all_present=1
  for mapping in "$@"; do
    var_name="${mapping%%=*}"
    op_ref="${mapping#*=}"
    [[ -n "$var_name" && -n "$op_ref" && "$mapping" == *"="* ]] || continue

    fetched_value="$(op read "$op_ref" 2>/dev/null)"
    if [[ -n "$fetched_value" ]]; then
      export "$var_name=$fetched_value"
    fi
  done

  for var_name in "${var_names[@]}"; do
    [[ -n "${(P)var_name}" ]] || all_present=0
  done

  if (( all_present )); then
    mkdir -p "$(dirname "$cache_file")"
    umask 077
    {
      for var_name in "${var_names[@]}"; do
        printf "export %s=%q\n" "$var_name" "${(P)var_name}"
      done
    } > "$cache_file"
  fi
}
